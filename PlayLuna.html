<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Responsive</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }

    #coverBox {
      width: 420px;
      height: 340px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
    }

    #coverImage {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
      pointer-events: none;
      user-select: none;
    }

    #tickerContainer {
      position: absolute;
      width: 400px;
      height: 50px;
      border-radius: 8px;
      top: 450px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 90;
      display: flex;
      align-items: center;
      background: transparent;
      font-weight: 600;
    }

    #leftBar, #rightBar {
      width: 20px;
      text-align: center;
      user-select: none;
      font-weight: 900;
      flex-shrink: 0;
      color: #fff;
    }

    #tickerWrapper {
      overflow: hidden;
      flex-grow: 1;
      height: 100%;
      position: relative;
    }

    #tickerText {
      white-space: nowrap;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      font-size: 20px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      user-select: none;
    }

    #npArtist {
      font-size: 24px;
      font-weight: 700;
      margin-right: 6px;
    }

    #npSong {
      font-size: 18px;
      font-weight: 400;
      opacity: 0.85;
    }

    /* ðŸ“± Responsive: Ingrandimento copertina solo su dispositivi mobili */
    @media screen and (max-width: 768px) {
      #coverBox {
        width: 460px;
        height: 370px;
        max-width: 95vw;
        top: 60px;
      }

      #tickerContainer {
        width: 440px;
        height: 48px;
        top: 450px;
      }
    }

    @media screen and (max-width: 480px) {
      #coverBox {
        width: 400px;
        height: 330px;
        top: 50px;
      }

      #tickerContainer {
        width: 380px;
        height: 45px;
        top: 400px;
      }
    }

    @media screen and (max-width: 360px) {
      #coverBox {
        width: 360px;
        height: 300px;
        top: 40px;
      }

      #tickerContainer {
        width: 340px;
        height: 42px;
        top: 370px;
      }
    }
  </style>
</head>
<body>

  <div id="coverBox">
    <img id="coverImage" alt="Cover" src="https://i.postimg.cc/Twyvg2gP/niiiii.png">
  </div>

  <div id="tickerContainer">
    <div id="leftBar">|</div>
    <div id="tickerWrapper">
      <div id="tickerText">
        <span id="npArtist"></span> <span id="npSong"></span>
      </div>
    </div>
    <div id="rightBar">|</div>
  </div>

  <script>
    const DEV_MODE = false;  // Cambia a true per abilitare il drag/spostamento
    const streamId = 'rtndtqysyq5tv';
    const metadataUrl = `https://api.zeno.fm/mounts/metadata/subscribe/${streamId}`;

    const artistEl = document.getElementById('npArtist');
    const songEl = document.getElementById('npSong');
    const coverImage = document.getElementById('coverImage');
    const coverBox = document.getElementById('coverBox');
    const tickerContainer = document.getElementById('tickerContainer');
    const tickerText = document.getElementById('tickerText');
    const tickerWrapper = document.getElementById('tickerWrapper');

    function savePosition(key, left, top) {
      localStorage.setItem(key, JSON.stringify({ left, top }));
    }

    function loadPosition(key) {
      const pos = localStorage.getItem(key);
      return pos ? JSON.parse(pos) : null;
    }

    function enableDrag(el, storageKey) {
      const pos = loadPosition(storageKey);

      if (DEV_MODE) {
        let offsetX, offsetY, dragging = false;

        el.style.position = 'absolute';
        if (pos) {
          el.style.left = pos.left + 'px';
          el.style.top = pos.top + 'px';
          el.style.transform = '';
        }

        el.addEventListener('mousedown', e => {
          dragging = true;
          offsetX = e.clientX - el.getBoundingClientRect().left;
          offsetY = e.clientY - el.getBoundingClientRect().top;
          el.style.cursor = 'grabbing';
          e.preventDefault();
        });

        window.addEventListener('mousemove', e => {
          if (!dragging) return;
          const left = e.clientX - offsetX;
          const top = e.clientY - offsetY;
          el.style.left = left + 'px';
          el.style.top = top + 'px';
          el.style.transform = '';
        });

        window.addEventListener('mouseup', () => {
          if (!dragging) return;
          dragging = false;
          el.style.cursor = 'grab';
          savePosition(storageKey, parseInt(el.style.left), parseInt(el.style.top));
        });

      } else {
        if (pos) {
          el.style.position = 'absolute';
          el.style.left = pos.left + 'px';
          el.style.top = pos.top + 'px';
          el.style.transform = '';
        } else {
          el.style.position = 'absolute';
          if (!el.style.left) el.style.left = '50%';
          if (!el.style.top) el.style.top = el.id === 'coverBox' ? '70px' : '450px';
          el.style.transform = 'translateX(-50%)';
        }
      }
    }

    enableDrag(coverBox, 'posCoverBox');
    enableDrag(tickerContainer, 'posTickerContainer');

    async function fetchItunesCover(artist, title) {
      try {
        const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist + ' ' + title)}&limit=1`);
        const data = await response.json();
        if (data.results && data.results.length > 0) {
          return data.results[0].artworkUrl100.replace('100x100bb', '300x300bb');
        }
      } catch (e) {
        console.error("Errore fetch iTunes:", e);
      }
      return 'https://i.postimg.cc/Twyvg2gP/niiiii.png';
    }

    let tickerPos = 0;
    const speed = 1.5;

    function animateTicker() {
      const textWidth = tickerText.offsetWidth;
      const wrapperWidth = tickerWrapper.offsetWidth;

      tickerPos -= speed;
      if (tickerPos < -textWidth) {
        tickerPos = wrapperWidth;
      }
      tickerText.style.transform = `translateX(${tickerPos}px) translateY(-50%)`;
      requestAnimationFrame(animateTicker);
    }

    animateTicker();

    const es = new EventSource(metadataUrl);
    es.onmessage = async event => {
      try {
        const data = JSON.parse(event.data);
        let [artist, title] = data.streamTitle.split(' â€“ ');
        artist = artist?.trim() || '';
        title = title?.trim() || '';
        artistEl.textContent = artist;
        songEl.textContent = title;

        const imgUrl = await fetchItunesCover(artist, title);
        coverImage.src = imgUrl;
      } catch (err) {
        console.error('Errore parsing metadata:', err, event.data);
      }
    };

    es.onerror = err => console.error('SSE error:', err);
  </script>

</body>
</html>
